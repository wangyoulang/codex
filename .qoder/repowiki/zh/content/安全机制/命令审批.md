# 命令审批

<cite>
**本文档引用的文件**  
- [exec_policy.rs](file://codex-rs\core\src\exec_policy.rs)
- [is_dangerous_command.rs](file://codex-rs\core\src\command_safety\is_dangerous_command.rs)
- [approval_overlay.rs](file://codex-rs\tui\src\bottom_pane\approval_overlay.rs)
- [approval_presets.rs](file://codex-rs\common\src\approval_presets.rs)
- [shell.rs](file://codex-rs\core\src\tools\runtimes\shell.rs)
- [codex.rs](file://codex-rs\core\src\codex.rs)
- [approval_mode_cli_arg.rs](file://codex-rs\common\src\approval_mode_cli_arg.rs)
</cite>

## 目录
1. [引言](#引言)
2. [核心机制](#核心机制)
3. [用户交互流程](#用户交互流程)
4. [配置与自定义](#配置与自定义)
5. [非交互式模式处理](#非交互式模式处理)
6. [安全与用户体验的平衡](#安全与用户体验的平衡)

## 引言
命令审批流程是Codex系统中至关重要的最后一道安全防线。当沙箱环境和执行策略无法完全阻止潜在危险命令时，该流程会介入，确保用户对关键操作拥有最终的控制权。此机制通过分析命令的潜在风险，结合预设的安全策略，决定是否需要暂停执行并请求用户批准，从而在自动化与安全性之间取得平衡。

## 核心机制
命令审批流程的核心在于对命令的双重评估：基于启发式规则的危险性检测和基于`execpolicy`的策略规则。

当一个命令需要执行时，系统首先通过`is_dangerous_command.rs`中的启发式规则进行评估。这些规则会检查命令是否包含已知的危险操作，例如`rm -rf`或`git reset`。如果命令被标记为危险，或者根据当前的审批策略（`AskForApproval`）需要用户介入，系统会触发审批流程。

同时，系统会加载并应用`execpolicy`规则。这些规则定义在`.rules`文件中，可以明确指定哪些命令前缀（prefix）应被允许（allow）、拒绝（forbidden）或需要审批（prompt）。`exec_policy.rs`文件中的`ExecPolicyManager`负责管理这些策略，并与启发式规则结合，最终决定命令的审批要求。

审批决策的结果是一个`ExecApprovalRequirement`枚举，它有三种状态：
- `Skip`：无需审批，直接执行。
- `NeedsApproval`：需要用户审批，此时会暂停执行并弹出交互式界面。
- `Forbidden`：命令被禁止执行。

**Section sources**
- [exec_policy.rs](file://codex-rs\core\src\exec_policy.rs#L109-L163)
- [is_dangerous_command.rs](file://codex-rs\core\src\command_safety\is_dangerous_command.rs#L12-L66)

## 用户交互流程
当系统确定一个命令需要用户审批时，会通过TUI（文本用户界面）中的`approval_overlay.rs`组件弹出一个交互式审批界面。

该界面会清晰地向用户展示以下信息：
1.  **命令详情**：以高亮的语法显示完整的命令行，让用户清楚地了解将要执行的操作。
2.  **风险提示**：如果存在，会显示一个“Reason”字段，解释为何需要审批，例如“execpolicy requires approval for this command”。
3.  **审批选项**：提供明确的“批准”或“拒绝”选项。

用户可以通过键盘快捷键进行选择：
- **批准**：通常使用 `y` 键或回车键（Enter）。
- **拒绝**：通常使用 `n` 键或退出键（Esc）。

此外，如果系统根据启发式规则推断出一个可以避免未来重复审批的策略（`proposed_execpolicy_amendment`），界面会提供一个额外的选项，例如“是的，且以后不再为此类命令询问”，用户选择后，系统会自动将该规则添加到用户的`execpolicy`中，实现“一次批准，永久信任”的效果。

**Section sources**
- [approval_overlay.rs](file://codex-rs\tui\src\bottom_pane\approval_overlay.rs#L74-L117)
- [approval_overlay.rs](file://codex-rs\tui\src\bottom_pane\approval_overlay.rs#L450-L478)

## 配置与自定义
命令审批行为可以通过配置文件进行深度自定义，主要涉及两个方面：审批策略和沙箱策略。

在`approval_presets.rs`中定义了几个内置的预设组合，用户可以在UI中选择：
- **只读 (Read Only)**：需要审批才能编辑文件和运行命令。
- **代理 (Agent)**：可以读写文件和运行命令，但关键操作仍需审批。
- **代理（完全访问）(Agent (full access))**：拥有完全权限，但使用时需格外谨慎。

用户可以通过配置文件（如`config.toml`）来覆盖这些预设，自定义`AskForApproval`和`SandboxPolicy`。例如，可以创建一个规则文件`rules/default.rules`，内容如下：
```toml
prefix_rule(pattern=["rm"], decision="prompt")
prefix_rule(pattern=["echo"], decision="allow")
```
这表示所有以`rm`开头的命令都需要用户审批，而以`echo`开头的命令则可以直接执行。

**Section sources**
- [approval_presets.rs](file://codex-rs\common\src\approval_presets.rs#L23-L45)
- [exec_policy.rs](file://codex-rs\core\src\exec_policy.rs#L208-L244)

## 非交互式模式处理
在非交互式模式（例如通过`exec`命令行工具运行）下，系统无法弹出交互式界面来请求用户批准。此时，处理策略由`approval_mode_cli_arg.rs`中定义的`--approval-mode`参数决定。

该参数支持多种模式：
- `--approval-mode=never`：从不请求用户批准，任何需要审批的命令都会被自动拒绝。
- `--approval-mode=on-failure`：仅在命令在沙箱中执行失败时才请求批准，以尝试在非沙箱环境中执行。
- `--approval-mode=untrusted`：仅对“不信任”的命令请求批准。
- `--approval-mode=on-request`：模型可以请求批准。

这种设计确保了自动化脚本和CI/CD流水线能够根据预设策略安全地运行，而不会因等待用户输入而阻塞。

**Section sources**
- [approval_mode_cli_arg.rs](file://codex-rs\common\src\approval_mode_cli_arg.rs#L8-L27)
- [shell.rs](file://codex-rs\core\src\tools\runtimes\shell.rs#L85-L121)

## 安全与用户体验的平衡
命令审批流程的设计核心在于平衡安全性与用户体验。过多的误报（即对无害命令频繁请求批准）会导致“批准疲劳”，用户可能会养成盲目点击“批准”的习惯，从而削弱了安全机制的有效性。

为了缓解这一问题，Codex采用了多层策略：
1.  **沙箱优先**：大多数命令首先在受限的沙箱环境中执行，只有当沙箱无法满足需求时才触发审批。
2.  **智能启发式**：通过`is_dangerous_command`等模块，系统能智能地识别真正危险的命令，减少对`ls`、`cat`等安全命令的打扰。
3.  **策略学习**：通过`proposed_execpolicy_amendment`机制，用户的一次性决策可以转化为长期的自动化规则，减少了未来的重复审批。

通过这种分层、智能且可配置的方法，Codex在保障系统安全的同时，最大限度地提升了用户的操作效率和体验。

**Section sources**
- [is_dangerous_command.rs](file://codex-rs\core\src\command_safety\is_dangerous_command.rs#L12-L66)
- [exec_policy.rs](file://codex-rs\core\src\exec_policy.rs#L250-L279)
- [codex.rs](file://codex-rs\core\src\codex.rs#L1047-L1078)