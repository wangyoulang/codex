# 故障排除

<cite>
**本文档中引用的文件**   
- [core/src/error.rs](file://codex-rs\core\src\error.rs)
- [app-server/src/error_code.rs](file://codex-rs\app-server\src\error_code.rs)
- [mcp-server/src/error_code.rs](file://codex-rs\mcp-server\src\error_code.rs)
- [tui2/src/lib.rs](file://codex-rs\tui2\src\lib.rs)
- [cli/src/main.rs](file://codex-rs\cli\src\main.rs)
- [core/src/auth.rs](file://codex-rs\core\src\auth.rs)
- [core/src/exec.rs](file://codex-rs\core\src\exec.rs)
- [core/src/lib.rs](file://codex-rs\core\src\lib.rs)
- [core/src/config_loader/mod.rs](file://codex-rs\core\src\config_loader\mod.rs)
- [core/src/rollout/recorder.rs](file://codex-rs\core\src\rollout\recorder.rs)
- [tui/src/session_log.rs](file://codex-rs\tui\src\session_log.rs)
- [tui2/src/session_log.rs](file://codex-rs\tui2\src\session_log.rs)
- [rmcp-client/src/logging_client_handler.rs](file://codex-rs\rmcp-client\src\logging_client_handler.rs)
</cite>

## 目录
1. [常见问题](#常见问题)
2. [启用详细日志记录](#启用详细日志记录)
3. [错误代码参考](#错误代码参考)
4. [性能问题排查](#性能问题排查)
5. [诊断信息收集](#诊断信息收集)

## 常见问题

### 身份验证失败
**症状描述**：用户在尝试登录或执行需要身份验证的操作时，系统返回身份验证错误，无法继续操作。

**可能的根本原因**：
- 刷新令牌已过期、被重复使用或已被撤销。
- 网络连接问题导致无法与身份验证服务器通信。
- 配置文件中的身份验证信息不正确或缺失。

**解决方案**：
1. 检查网络连接是否正常。
2. 确认配置文件中的身份验证信息是否正确。
3. 如果刷新令牌已过期，重新进行登录操作以获取新的令牌。

**Section sources**
- [core/src/auth.rs](file://codex-rs\core\src\auth.rs#L547-L583)
- [core/src/error.rs](file://codex-rs\core\src\error.rs#L215-L237)

### 模型连接超时
**症状描述**：在与模型进行通信时，请求长时间无响应，最终超时。

**可能的根本原因**：
- 网络延迟或不稳定。
- 模型服务器负载过高。
- 请求的数据量过大，处理时间过长。

**解决方案**：
1. 检查网络连接，确保网络稳定。
2. 减少请求的数据量，分批处理。
3. 增加请求的超时时间。

**Section sources**
- [core/src/exec.rs](file://codex-rs\core\src\exec.rs#L377-L378)
- [core/src/error.rs](file://codex-rs\core\src\error.rs#L47-L48)

### 沙箱权限错误
**症状描述**：在沙箱环境中执行命令时，由于权限不足导致命令执行失败。

**可能的根本原因**：
- 沙箱策略配置过于严格，限制了必要的文件系统访问。
- 命令尝试访问被沙箱策略禁止的资源。

**解决方案**：
1. 检查并调整沙箱策略，确保必要的文件系统访问权限。
2. 确认命令是否尝试访问被禁止的资源，如有必要，修改命令或资源路径。

**Section sources**
- [core/src/exec.rs](file://codex-rs\core\src\exec.rs#L401-L421)
- [core/src/error.rs](file://codex-rs\core\src\error.rs#L27-L57)

### 命令执行失败
**症状描述**：执行命令时，命令未能成功完成，返回错误信息。

**可能的根本原因**：
- 命令本身存在语法错误或逻辑错误。
- 执行环境缺少必要的依赖或库。
- 命令超时或被信号中断。

**解决方案**：
1. 检查命令的语法和逻辑，确保正确无误。
2. 确认执行环境是否包含所有必要的依赖和库。
3. 增加命令的超时时间，或检查是否有信号中断。

**Section sources**
- [core/src/exec.rs](file://codex-rs\core\src\exec.rs#L520-L562)
- [core/src/error.rs](file://codex-rs\core\src\error.rs#L84-L91)

## 启用详细日志记录

通过设置 `RUST_LOG` 环境变量来启用详细日志记录，以便诊断问题。例如，设置 `RUST_LOG=info` 可以输出信息级别的日志，设置 `RUST_LOG=debug` 可以输出调试级别的日志。

**关键日志条目含义**：
- `INFO`：一般信息，用于跟踪程序的正常运行流程。
- `DEBUG`：调试信息，用于详细跟踪程序的内部状态和变量值。
- `ERROR`：错误信息，表示程序运行中遇到的错误。

**Section sources**
- [tui2/src/lib.rs](file://codex-rs\tui2\src\lib.rs#L277-L281)
- [rmcp-client/src/logging_client_handler.rs](file://codex-rs\rmcp-client\src\logging_client_handler.rs#L16-L19)

## 错误代码参考

| 错误代码 | 描述 |
|--------|------|
| -32600 | 无效请求错误 |
| -32603 | 内部错误 |

**Section sources**
- [app-server/src/error_code.rs](file://codex-rs\app-server\src\error_code.rs#L1-L2)
- [mcp-server/src/error_code.rs](file://codex-rs\mcp-server\src\error_code.rs#L1-L2)

## 性能问题排查

### 高内存使用
**症状描述**：程序运行时内存使用量异常高，可能导致系统变慢或崩溃。

**可能的根本原因**：
- 内存泄漏，导致内存无法被及时释放。
- 数据结构设计不合理，占用过多内存。

**解决方案**：
1. 使用内存分析工具检查内存使用情况，定位内存泄漏点。
2. 优化数据结构，减少不必要的内存占用。

### 响应延迟
**症状描述**：程序响应时间过长，用户体验不佳。

**可能的根本原因**：
- 网络延迟或带宽不足。
- 服务器处理能力不足。
- 数据库查询效率低下。

**解决方案**：
1. 优化网络连接，确保带宽充足。
2. 增加服务器资源，提高处理能力。
3. 优化数据库查询，减少查询时间。

**Section sources**
- [core/src/lib.rs](file://codex-rs\core\src\lib.rs#L1-L130)
- [core/src/config_loader/mod.rs](file://codex-rs\core\src\config_loader\mod.rs#L203-L232)

## 诊断信息收集

为了向社区或支持团队寻求帮助，需要收集以下诊断信息：
- 日志文件：包含程序运行时的详细日志信息。
- 配置文件片段：包含程序的配置信息，有助于分析问题。

**收集方法**：
1. 启用详细日志记录，确保日志文件包含足够的信息。
2. 复制相关配置文件片段，确保包含所有必要的配置项。

**Section sources**
- [core/src/rollout/recorder.rs](file://codex-rs\core\src\rollout\recorder.rs#L335-L369)
- [tui/src/session_log.rs](file://codex-rs\tui\src\session_log.rs#L165-L210)
- [tui2/src/session_log.rs](file://codex-rs\tui2\src\session_log.rs#L165-L210)