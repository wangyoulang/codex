# 沙箱测试命令

<cite>
**本文档中引用的文件**  
- [sandbox.md](file://docs/sandbox.md)
- [debug_sandbox.rs](file://codex-rs/cli/src/debug_sandbox.rs)
- [main.rs](file://codex-rs/cli/src/main.rs)
- [seatbelt.rs](file://codex-rs/core/src/seatbelt.rs)
- [landlock.rs](file://codex-rs/core/src/landlock.rs)
- [lib.rs](file://codex-rs/windows-sandbox-rs/src/lib.rs)
- [policy.rs](file://codex-rs/windows-sandbox-rs/src/policy.rs)
- [sandbox_smoketests.py](file://codex-rs/windows-sandbox-rs/sandbox_smoketests.py)
- [exec_policy.rs](file://codex-rs/core/src/exec_policy.rs)
- [protocol.rs](file://codex-rs/protocol/src/protocol.rs)
</cite>

## 目录
1. [简介](#简介)
2. [命令使用方法](#命令使用方法)
3. [跨平台沙箱机制](#跨平台沙箱机制)
4. [测试场景与输出分析](#测试场景与输出分析)
5. [execpolicy 策略文件](#execpolicy-策略文件)
6. [故障排除与配置调整](#故障排除与配置调整)

## 简介

`codex sandbox` 命令是一个诊断和验证工具，用于测试和调试 Codex 的沙箱配置。它允许用户在受控环境中运行命令，以验证沙箱策略是否按预期工作。该命令通过模拟 Codex 代理的沙箱行为，帮助用户理解不同操作系统（Linux、macOS、Windows）下的权限限制，例如文件系统访问、网络连接和进程创建等。

此工具对于开发人员和系统管理员特别有用，可以确保沙箱配置既安全又有效，防止潜在的安全漏洞，同时保证必要的功能不受影响。

**Section sources**
- [sandbox.md](file://docs/sandbox.md#L82-L97)
- [debug_sandbox.rs](file://codex-rs/cli/src/debug_sandbox.rs#L56-L101)

## 命令使用方法

`codex sandbox` 命令提供了一个 CLI 接口，用于在不同的沙箱模式下运行指定的命令。其基本语法如下：

```bash
# macOS
codex sandbox macos [--full-auto] [COMMAND]...

# Linux
codex sandbox linux [--full-auto] [COMMAND]...

# Windows
codex sandbox windows [--full-auto] [COMMAND]...
```

其中，`--full-auto` 标志用于启用完全自动模式，该模式下沙箱将允许更多的操作，类似于生产环境中的“全访问”模式。如果不使用 `--full-auto`，则默认为只读模式，限制更严格。

此外，还存在一些遗留别名，如 `codex debug seatbelt` 和 `codex debug landlock`，它们分别对应于 macOS 和 Linux 的特定沙箱实现。

**Section sources**
- [sandbox.md](file://docs/sandbox.md#L82-L97)
- [main.rs](file://codex-rs/cli/src/main.rs#L163-L180)

## 跨平台沙箱机制

Codex 的沙箱机制根据操作系统的不同而有所差异，具体如下：

### macOS

在 macOS 上，Codex 使用 Apple 的 Seatbelt 框架来实施沙箱。通过调用 `sandbox-exec` 并传递相应的配置文件，可以限制文件系统和网络访问。Seatbelt 配置文件定义了哪些路径可读写，以及是否允许网络连接。

### Linux

在 Linux 上，Codex 结合使用 Landlock 和 seccomp API 来实现沙箱。Landlock 提供了文件系统级别的访问控制，而 seccomp 则限制了系统调用。这种组合提供了与 macOS 类似的安全保障。然而，需要注意的是，较旧的内核可能不支持这些特性，导致沙箱功能受限。

### Windows

Windows 上的沙箱支持仍处于实验阶段。它通过创建一个受限令牌并附加特定的能力 SID 来工作。此外，通过覆盖代理相关的环境变量和插入存根可执行文件来禁用出站网络访问。主要限制在于无法阻止在 Everyone SID 具有写权限的目录中的文件写入、删除或创建。

**Section sources**
- [sandbox.md](file://docs/sandbox.md#L58-L80)
- [seatbelt.rs](file://codex-rs/core/src/seatbelt.rs#L23-L44)
- [landlock.rs](file://codex-rs/core/src/landlock.rs#L16-L40)
- [lib.rs](file://codex-rs/windows-sandbox-rs/src/lib.rs#L85-L427)

## 测试场景与输出分析

`codex sandbox` 命令可用于测试多种场景，包括但不限于：

- **文件系统访问**：测试对特定目录的读写权限。
- **网络连接**：验证是否能够发起网络请求。
- **进程创建**：检查是否可以启动新的进程。

### 示例输出

成功执行的命令通常会返回正常的退出码（0），并且输出中不会包含任何错误信息。例如：

```bash
$ codex sandbox macos --full-auto echo "Hello, World!"
Hello, World!
```

失败的测试结果则可能显示权限被拒绝或其他错误。例如：

```bash
$ codex sandbox macos rm -rf /tmp
rm: /tmp: Operation not permitted
```

在这种情况下，输出表明尝试删除 `/tmp` 目录被拒绝，因为该操作超出了沙箱的权限范围。

**Section sources**
- [sandbox_smoketests.py](file://codex-rs/windows-sandbox-rs/sandbox_smoketests.py#L126-L164)
- [exec_policy.rs](file://codex-rs/core/src/exec_policy.rs#L560-L950)

## execpolicy 策略文件

`execpolicy` 是一个用于定义命令执行策略的文件格式。它允许用户指定哪些命令需要审批，哪些可以直接执行。策略文件可以通过 `execpolicy check` 命令进行验证，确保其正确性。

例如，一个简单的策略文件可能如下所示：

```toml
prefix_rule(pattern=["rm"], decision="prompt")
```

这表示每当执行 `rm` 命令时，都需要用户确认。通过调整 `execpolicy` 文件，用户可以根据实际需求微调沙箱的行为，确保既安全又灵活。

**Section sources**
- [exec_policy.rs](file://codex-rs/core/src/exec_policy.rs#L40-L634)
- [main.rs](file://codex-rs/execpolicy/src/main.rs#L1-L19)

## 故障排除与配置调整

当 `codex sandbox` 命令的测试结果不符合预期时，可以通过以下步骤进行故障排除和配置调整：

1. **检查沙箱策略**：确认当前使用的沙箱策略是否正确配置。可以通过查看 `config.toml` 文件中的 `sandbox_mode` 和 `approval_policy` 设置来验证。
2. **更新 execpolicy 文件**：如果某些命令被错误地阻止或允许，可以修改 `execpolicy` 文件以添加或删除规则。
3. **运行烟雾测试**：对于 Windows 平台，可以运行 `python windows-sandbox-rs/sandbox_smoketests.py` 来验证沙箱配置的有效性。
4. **查阅日志**：检查沙箱日志文件，通常位于 `.codex/.sandbox` 目录下，以获取更多关于失败原因的信息。

通过这些步骤，用户可以有效地调试和优化沙箱配置，确保其满足特定的应用需求。

**Section sources**
- [windows_sandbox_security.md](file://docs/windows_sandbox_security.md#L20-L23)
- [sandbox_smoketests.py](file://codex-rs/windows-sandbox-rs/sandbox_smoketests.py#L126-L164)
- [config.md](file://docs/config.md)