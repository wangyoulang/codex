# 自定义提示词

<cite>
**本文档引用的文件**   
- [custom_prompts.rs](file://codex-rs/core/src/custom_prompts.rs)
- [project_doc.rs](file://codex-rs/core/src/project_doc.rs)
- [prompt_args.rs](file://codex-rs/tui/src/bottom_pane/prompt_args.rs)
- [prompt_args.rs](file://codex-rs/tui2/src/bottom_pane/prompt_args.rs)
- [custom_prompts.rs](file://codex-rs/protocol/src/custom_prompts.rs)
- [agents_md.md](file://docs/agents_md.md)
- [config.md](file://docs/config.md)
- [prompts.md](file://docs/prompts.md)
</cite>

## 目录
1. [简介](#简介)
2. [自定义提示词配置与加载](#自定义提示词配置与加载)
3. [项目上下文文档（Project Doc）](#项目上下文文档project-doc)
4. [提示词语法与变量替换机制](#提示词语法与变量替换机制)
5. [使用场景示例](#使用场景示例)
6. [与技能系统结合使用](#与技能系统结合使用)
7. [最佳实践与潜在风险](#最佳实践与潜在风险)

## 简介
Codex 允许用户通过自定义提示词（Custom Prompts）功能来引导 AI 的行为。用户可以通过在配置文件或命令行中定义提示词，创建高度专业化的 AI 代理。这些提示词可以包含变量占位符，并通过命令行参数进行动态替换。此外，Codex 还支持从项目中的 `AGENTS.md` 文件读取上下文信息，作为提示词的一部分，从而为 AI 提供更丰富的项目背景。

## 自定义提示词配置与加载
自定义提示词存储在 `$CODEX_HOME/prompts` 目录下的 `.md` 文件中。每个文件代表一个可调用的提示词，其文件名（不含扩展名）即为提示词的名称。系统通过 `default_prompts_dir()` 函数确定默认的提示词目录。

提示词文件支持 YAML 风格的前置元数据（frontmatter），用于定义描述和参数提示：
- `description`: 在斜杠命令弹窗中显示的简短描述。
- `argument-hint` 或 `argument_hint`: 显示在描述后的参数提示字符串。

系统通过 `discover_prompts_in()` 函数异步发现并加载指定目录中的所有提示词文件，返回按名称排序的 `CustomPrompt` 结构体列表。`CustomPrompt` 结构体包含名称、路径、内容、描述和参数提示等字段。

**Section sources**
- [custom_prompts.rs](file://codex-rs/core/src/custom_prompts.rs#L1-L245)
- [protocol/src/custom_prompts.rs](file://codex-rs/protocol/src/custom_prompts.rs#L1-L20)

## 项目上下文文档（Project Doc）
Codex 使用 `AGENTS.md` 文件作为项目级别的文档，为 AI 提供项目上下文。系统通过 `get_user_instructions()` 函数将全局配置指令与项目文档合并，形成最终的用户指令。

文档发现规则如下：
1.  **确定 Git 仓库根目录**：从当前工作目录向上遍历，直到找到 `.git` 目录或文件。
2.  **收集文档文件**：从仓库根目录到当前工作目录（包含）的路径上，收集所有 `AGENTS.override.md` 和 `AGENTS.md` 文件。`AGENTS.override.md` 优先级高于 `AGENTS.md`。
3.  **内容拼接**：按从根目录到当前目录的顺序，将所有找到的文档内容拼接在一起。

此外，用户还可以通过 `project_doc_fallback_filenames` 配置项指定额外的备选文件名。文档内容的最大总字节数由 `project_doc_max_bytes` 配置项控制，超出部分会被截断。

**Section sources**
- [project_doc.rs](file://codex-rs/core/src/project_doc.rs#L1-L554)
- [agents_md.md](file://docs/agents_md.md#L1-L51)
- [config.md](file://docs/config.md#L1-L200)

## 提示词语法与变量替换机制
自定义提示词支持两种变量替换机制：命名占位符和数字占位符。

### 命名占位符
命名占位符的格式为 `$[A-Z][A-Z0-9_]*`，例如 `$USER` 或 `$TICKET_ID`。在调用提示词时，需要提供 `KEY=value` 形式的键值对参数。系统通过 `parse_prompt_inputs()` 函数解析这些参数，并通过正则表达式 `PROMPT_ARG_REGEX` 将占位符替换为实际值。如果提示词中定义了必需的命名占位符但调用时未提供相应参数，系统会返回错误。

### 数字占位符
数字占位符包括 `$1` 到 `$9` 和 `$ARGUMENTS`。`$1` 到 `$9` 分别对应命令行中的前九个位置参数，`$ARGUMENTS` 则会将所有位置参数用空格连接后插入。系统通过 `expand_numeric_placeholders()` 函数实现数字占位符的替换。

### 特殊字符
使用 `$$` 可以输出一个字面量的美元符号 `$`，以避免被误认为是占位符。

**Section sources**
- [prompt_args.rs](file://codex-rs/tui/src/bottom_pane/prompt_args.rs#L1-L407)
- [prompt_args.rs](file://codex-rs/tui2/src/bottom_pane/prompt_args.rs#L1-L407)
- [prompts.md](file://docs/prompts.md#L28-L97)

## 使用场景示例
### 示例1：生成提交信息
创建一个名为 `ticket.md` 的提示词文件，用于根据工单信息生成提交信息。
```markdown
---
description: 为工单生成提交信息
argument-hint: TICKET_ID=<id> TICKET_TITLE=<title>
---
请为工单 $TICKET_ID: $TICKET_TITLE 写一个简洁的提交信息。
```
调用方式：`/prompts:ticket TICKET_ID=BUG-123 TICKET_TITLE="修复登录错误"`

### 示例2：代码审查
创建一个名为 `review.md` 的提示词文件，用于指导代码审查。
```markdown
---
description: 审查指定文件的代码
argument-hint: FILE=<path> [PRIORITY=high|medium|low]
---
请审查 $FILE 中的代码。$ARGUMENTS
```
调用方式：`/prompts:review FILE=src/auth.js PRIORITY=high`

### 示例3：框架特定的编码助手
为 React 项目创建一个名为 `react_component.md` 的提示词，要求 AI 遵循特定的代码风格。
```markdown
---
description: 创建一个符合项目规范的 React 组件
argument-hint: NAME=<component_name>
---
请使用函数式组件和 Hooks 创建一个名为 $NAME 的 React 组件。组件应使用 TypeScript，遵循项目中的样式指南，并包含必要的 PropTypes 验证。
```

## 与技能系统结合使用
自定义提示词可以与 Codex 的技能系统（Skills）结合使用，以创建功能更强大的 AI 代理。当 `skills` 功能启用时，`get_user_instructions()` 函数会将发现的技能列表附加到项目文档之后。技能列表包含技能名称、描述和文件路径，并附带使用规则。

用户可以在提示词中直接引用技能名称（例如 `$SkillName`），AI 会根据触发规则自动加载并使用相应的技能。这使得用户可以创建一个调用多个技能的复合提示词，实现复杂的自动化工作流。

**Section sources**
- [project_doc.rs](file://codex-rs/core/src/project_doc.rs#L490-L545)

## 最佳实践与潜在风险
### 最佳实践
- **清晰命名**：为提示词选择清晰、有意义的名称，便于在斜杠命令弹窗中识别。
- **提供描述和提示**：始终为提示词添加 `description` 和 `argument-hint`，以指导用户正确使用。
- **模块化设计**：将复杂的逻辑拆分为多个小的、可重用的提示词，而不是创建一个巨大的提示词。
- **利用项目文档**：将通用的项目规范和指南写入 `AGENTS.md` 文件，避免在每个提示词中重复。

### 潜在风险
- **配置冲突**：全局指令、项目文档和自定义提示词之间可能存在优先级冲突。应遵循“越具体，优先级越高”的原则进行管理。
- **滥用风险**：过于复杂的提示词或技能组合可能导致 AI 行为不可预测或产生意外的副作用。应进行充分的测试。
- **安全风险**：提示词可能被用来引导 AI 执行不安全的操作。应结合 Codex 的沙箱和审批机制来控制风险。